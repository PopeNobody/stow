#!/usr/bin/perl
#! -*- perl -*- -p
eval 'exec perl -x -wS $0 ${1+"$@"}'
  if 0;


use FindBin qw($Script $Bin);
use lib "$Bin/../lib/perl";

if($< or $>) {
 exec "sudo", readlink("/proc/self/exe"),"$Bin/$Script", @ARGV;
}

use strict;
use warnings;
use autodie qw(:all);
our ($VERSION) = join("-",qw ( 1 0 0 ));
BEGIN {
  $|++; $\="\n";
};
use Nobody::PP qw(ddx dd ppx pp);
use Getopt::WonderBra;
use File::Path;
use Util;
use autodie qw(:all);
use POSIX qw(strftime);
sub write_klog(@);
sub test_klog();
sub serdate()
{
  my @time=gmtime;
  return strftime("%Y%m%d-%H%M%S-gmt", @time);
}
my $gzip="|gzip -9";
sub gzip_append($@){
  my ($fn)=shift;
  chomp(@_);
  $_=join("\n",@_);
  open(STDOUT,"$gzip>>$fn");
  print(STDOUT "$_");
  close(STDOUT);
  open(STDOUT,">&STDERR");
}
sub get_filename()
{
  my $new=shift;
  unless(-e "current.gz"){
    my $realfile=join("","dmesg-",serdate(),".gz");
    symlink($realfile,"current.gz");
  };
  return "current.gz";
}
mkpath("/var/log/dmesg");
chdir("/var/log/dmesg");
sub version {
  print "version $VERSION";
}
sub help {
  print "usage: $0 [ -a ]";
  print "       -a: append to existing output";
  print "";
}
{
  write_klog("fake","data");
  open(my $dmesg,"dmesg|");
  exit(0) unless defined($_=<$dmesg>);
  my $fn=get_filename();
  my @dmesg=$_;
  push(@dmesg, <$dmesg>);
  close($dmesg);
  gzip_append($fn,@dmesg);


  #  test_klog();

  my $lines=@dmesg;
  open($dmesg,"dmesg -c|");
  @dmesg=<$dmesg>;
  splice(@dmesg,0,$lines);
  if(@dmesg){
    unshift(@dmesg,"more lines appeared");
    print STDERR "more lines appeared";
    gzip_append($fn,@dmesg);
  }
}
sub write_klog(@) {
  local(@_)=@_;
  open(my $klog,">>/dev/kmsg");
  chomp(@_);
  $klog->print(join("\n",@_));
  close($klog);
};
sub test_klog() {
  write_klog(qw( this is a test ));
};
