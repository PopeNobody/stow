#!/usr/bin/perl
#! -*- perl -*- -p
eval 'exec perl -x -wS $0 ${1+"$@"}'
  if 0;

use strict;
use warnings;
use autodie qw(:all);
our ($VERSION) = join("-",qw ( 1 0 0 ));
BEGIN {
  use FindBin qw($Script $Bin);
  use lib "$Bin/../lib/perl";
  $|++;
  $\="\n";
  exec "sudo", "$Bin/$Script", @ARGV
    if $< or $>;
};
use Data::Dump qw(ddx dd ppx pp);
use Getopt::WonderBra;
sub version {
  print "version $VERSION";
}
sub help {
  print "usage: $0 [ -a ]";
  print "       -a: append to existing output";
  print "";
}
sub kmsg(@) {
  @_ = $_ unless @_;
  open(my $kmsg,">>/dev/kmsg");
  print $kmsg "$_" for @_;
  close($kmsg);
}
sub dmesg {
  my ($dmesg);
  open($dmesg,"dmesg |");
  @_ = grep { chomp || 1 } <$dmesg>;
  close($dmesg);
  return @_;
}
sub get_filename($) {
  my $new=shift;
  my ($dir) = "/var/log/dmesg";
  my ($fn);
  mkdir $dir unless -d "$dir";

  unless($new) {
    my @fn=sort glob("$dir/dmesg-*.gz");
    $fn=shift @fn;
  }
  if(defined($fn)) {
    print STDERR "old file";
  } else {
    print STDERR "new file";
    $fn=sprintf("$dir/dmesg-%s.gz", map { split } qx(serdate));
  }
  return $fn;
}
sub main(@) {
  kmsg("$0 running (@ARGV)");
  my @dmesg = dmesg();
  my $new=0;
  for(map { "$_" } $dmesg[0]) {
    $new=1 if s/^\[[0-9. ]*\] microcode//;
  };
  my $fn=get_filename($new);
  my @omesg;
  if($new) {
    print "yep, new";
  } else {
    @omesg=grep { length } split("\n",join("\n",qx(test -e $fn && zcat $fn)));
    printf "read %d lines\n", scalar(@omesg);
    print STDERR "skipping read";
  };
  printf STDERR "writing %d new lines (and %d old onees) to %s\n", scalar(@dmesg), scalar(@omesg), $fn;
  open(STDOUT,"| gzip >$fn.new");
  print for ( @omesg, @dmesg );
  close(STDOUT);
  rename "$fn.new", "$fn";
  system("dmesg -c > /dev/null 2>&1");
}
main(@ARGV);
