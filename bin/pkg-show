#!/usr/bin/perl
# vim: ts=2 sw=2 ft=perl
eval 'exec perl -x -wS $0 ${1+"$@"}'
  if 0;
BEGIN { package DB; $CreateTTY=4; };
use strict;
use warnings;
use autodie;
use Time::HiRes qw(time);
use Nobody::Util;
use Fcntl;
use Fcntl qw(O_NONBLOCK);
use Env qw($HOME @PATH);
BEGIN {
  our(@VERSION) = qw( 0 1 0 );
  sub version {
    print join(".",@VERSION);
  }
  sub help {
    print grep { chomp; 1 } <DATA>;
  };
  use Getopt::WonderBra;
}
  our(%cmd,@cmd);
sub pkg_name(@);
sub opts(@);
use feature qw(say);
sub main(@);

#@ARGV = qw(-n) unless @ARGV;
exit(main(opts(getopt("n",@ARGV))));
die "NONE SHALL PASS";

sub group($@);
my $use_pkg_name=0;
our(%opts);
sub opts(@){
  local(@_,$_)=@_;
  while(($_=shift)ne'--'){
    if( $_ eq '-n' ) {
      $use_pkg_name=1;
    } else {
      die "unexpected: ($_)";
    }
  };
  return @_;
};
my %pid;
sub reap {
  my $pid=waitpid(-1,0);
  print "freaped $$\n";
  my $res=$?;
  $cmd{$pid}{res}=$res;
  delete $pid{$pid};
};  
sub show_proc($) {
  my $pid=shift;
  warn("$$:$pid\n");
  for(0 .. 2) {
    my $name="/proc/$pid/fd/$_";
    warn("$name => ", readlink($name),"\n");
  };
};
sub run_pipe(@){
  open(STDIN,"</dev/null");
  our (@cmd)= @_;
  my $pid=0;
  show_proc($$);
  for my $cmd(@cmd) {
    $pid=open(STDIN,'-|');
    if(!$pid) {
      warn("$$ $pid: @$cmd\n");
      exec(@$cmd);
      die "exec @cmd";
    };
    show_proc($pid);
    $cmd{$pid}{pid}=$pid;
    $cmd{$pid}{cmd}="@$cmd";
    $pid{$pid}=$pid;
  };
  my $pkg;
  while(<STDIN>)
  {
    if(s{^Package: *}{}) {
      $pkg="$_";
    } else {
      s[^[^:]+:][   ];
      print "$pkg:$_\n";
    };
  };
  close(STDIN);
}
sub main(@){
  my (@args) = splice(@_);
  @args=qw( . ) unless @args;
  push(@cmd,["pkg-name", @args]);
  push(@cmd,[ qw( xargs apt-cache show ) ]);
  push(@cmd,[ qw( egrep ^(Package:|Desc) ) ] );
  push(@cmd,[ qw( egrep -v md5: ) ] );
  run_pipe(@cmd);
  return 0;
};
sub group($@){
  my $title=shift;
  @_=sort { $a->[0] cmp $b->[0] } @_;
  print join(".",@$_) for @_;
};
__DATA__
usage: $0 [-n] <pkg-name>
       <pkg-name> = the name of a package

      -n: use pkg-name to expand the pkgname

      use -n . to show all packages
      };
